"0","rproc <- Csnippet("""
"0","    double gamma = 1.0;"
"0","    double d_1=1/(5.0*52.0);           // d1 = 0.003846154"
"0","    double d_2=1/(55.0*52.0);          // d2 = 0.0003496503"
"0","    double N = 82372825;"
"0","    double alpha = 1/(78.86912*52.0);  // alpha = 0.0002438314"
"0","    double delta = 1 - 1/(18.86912*52.0);  // delta = 0.9989808"
"0","    double omega = 1/(1.0*52.0);         // omega = 0.01923077"
"0","    "
"0","    int I = I_1 + I_2 + I_3;"
"0","    int trans_S1[3], trans_S2[3], trans_S3[2], trans_I1[3], trans_I2[3], trans_I3[2], trans_R1[3], trans_R2[3], trans_R3[2];"
"0","    "
"0","    double prob_S1[3],prob_I1[3],prob_R1[3],prob_S2[3],prob_I2[3],prob_R2[3],prob_S3[2],prob_I3[2],prob_R3[2];"
"0","    "
"0","    double kappa = (1 + rho*cos(2*3.141593*t/52 + phi));"
"0","    double Beta_1 = beta1*kappa; //seasonal forcing"
"0","    double Beta_2 = beta2*kappa; //seasonal forcing"
"0","    double Beta_3 = beta3*kappa; //seasonal forcing"
"0","    "
"0","    // Define rate"
"0","    prob_S1[0] = 1-exp(-Beta_1*I/N*dt);"
"0","    prob_S1[1] = 1-exp(-dt*d_1);"
"0","    prob_S1[2] = exp(-dt*d_1) + exp(-Beta_1*I/N*dt) - 1;"
"0","    "
"0","    prob_I1[0] = 1-exp(-dt*gamma);"
"0","    prob_I1[1] = 1-exp(-dt*d_1);"
"0","    prob_I1[2] = exp(-dt*gamma)+exp(-dt*d_1) - 1;"
"0","    "
"0","    prob_R1[0] = 1 - exp(-dt*omega);  // E_1,t this goes back to S_1,(t+1)"
"0","    prob_R1[1] = 1 - exp(-dt*d_1);"
"0","    prob_R1[2] = exp(-dt*omega) + exp(-dt*d_1) - 1;"
"0","    "
"0","    prob_S2[0] = 1-exp(-Beta_2*I/N*dt);"
"0","    prob_S2[1] = 1-exp(-dt*d_2);"
"0","    prob_S2[2] = exp(-dt*d_2) + exp(-Beta_2*I/N*dt) - 1;"
"0","    "
"0","    prob_I2[0] = 1-exp(-dt*gamma);"
"0","    prob_I2[1] = 1-exp(-dt*d_2);"
"0","    prob_I2[2] = exp(-dt*gamma)+exp(-dt*d_2) - 1;"
"0","    "
"0","    prob_R2[0] = 1 - exp(-dt*omega);  // E_1,t this goes back to S_1,(t+1)"
"0","    prob_R2[1] = 1 - exp(-dt*d_1);"
"0","    prob_R2[2] = exp(-dt*omega) + exp(-dt*d_1) - 1;"
"0","    "
"0","    // For Age Group (3): Die first before transition;"
"0","    "
"0","    double S3mD = rbinom(S_3, delta);"
"0","    double I3mD = rbinom(I_3, delta);"
"0","    double R3mD = rbinom(R_3, delta);"
"0","    "
"0","    prob_S3[0] = 1-exp(-Beta_3*I/N*dt);"
"0","    prob_S3[1] = exp(-Beta_3*I/N*dt);"
"0","    "
"0","    prob_I3[0] = 1 - exp(-dt*gamma);"
"0","    prob_I3[1] = exp(-dt*gamma);"
"0","    "
"0","    prob_R3[0] = 1 - exp(-dt*omega);"
"0","    prob_R3[1] = exp(-dt*omega);"
"0","    "
"0","    // Transition"
"0","    // B: S->I"
"0","    // C: I->R"
"0","    // F: Aging: (1)->(2)->(3)"
"0","    // E: R->S"
"0","    // D: Death"
"0","    //// Note: Here S_1, S_2... are all old value from (t-1)"
"0","    rmultinom(S_1, &prob_S1, 3, &trans_S1); // B, F, S-B-F"
"0","    rmultinom(I_1, &prob_I1, 3, &trans_I1); // C, F, I-C-F"
"0","    rmultinom(R_1, &prob_R1, 3, &trans_R1); // E, F, R-E-F"
"0","    "
"0","    rmultinom(S_2, &prob_S2, 3, &trans_S2); // B, F, S-B-F"
"0","    rmultinom(I_2, &prob_I2, 3, &trans_I2); // C, F, I-C-F"
"0","    rmultinom(R_2, &prob_R2, 3, &trans_R2); // E, F, R-E-F"
"0","    "
"0","    rmultinom(S3mD, &prob_S3, 2, &trans_S3); // B, (S-D)-B"
"0","    rmultinom(I3mD, &prob_I3, 2, &trans_I3); // C, (I-D)-C"
"0","    rmultinom(R3mD, &prob_R3, 2, &trans_R3); // E, (R-D)-E"
"0","    "
"0","    S_1 = trans_S1[2] + trans_R1[0] + rpois(alpha*N*dt); // Include Birth"
"0","    I_1 = trans_I1[2] + trans_S1[0];"
"0","    R_1 = trans_R1[2] + trans_I1[0];"
"0","    "
"0","    S_2 = trans_S2[2] + trans_R2[0] + trans_S1[1]; // Include Aging"
"0","    I_2 = trans_I2[2] + trans_S2[0] + trans_I1[1];"
"0","    R_2 = trans_R2[2] + trans_I2[0] + trans_R1[1];"
"0","    "
"0","    S_3 = trans_S3[1] + trans_R3[0] + trans_S2[1]; // Include Aging"
"0","    I_3 = trans_I3[1] + trans_S3[0] + trans_I2[1];"
"0","    R_3 = trans_R3[1] + trans_I3[0] + trans_R2[1];"
"0","    "
"0","    //Accumvar"
"0","    H_1 += trans_S1[0];"
"0","    H_2 += trans_S2[0];"
"0","    H_3 += trans_S3[0];"
"0",""")"
"0",""
"0","## ----rinit-------------------------------------------------"
"0","rinit <- Csnippet("""
"0","    I_1=452;"
"0","    I_2=68;"
"0","    I_3=41;"
"0","    S_1=5.20208e+06;"
"0","    S_2=5.74359e+07;"
"0","    S_3=1.97052e+07;"
"0","    R_1=19586;"
"0","    R_2=7320;"
"0","    R_3=2151;"
"0","    H_1 = 0;"
"0","    H_2 = 0;"
"0","    H_3 = 0;"
"0",""")"
"0",""
"0",""
"0","## ----rmeasure-------------------------------------------------"
"0","rmeas <- Csnippet("""
"0","  if(t<209){"
"0","    cases1 = rbinom(H_1, 0.06652121); // this is observed cases"
"0","    cases2 = rbinom(H_2, 0.06652121);"
"0","    cases3 = rbinom(H_3, 0.06652121);"
"0","  }"
"0","  else{"
"0","    cases1 = rbinom(H_1, 0.09283434); // this is observed cases"
"0","    cases2 = rbinom(H_2, 0.09283434);"
"0","    cases3 = rbinom(H_3, 0.09283434);"
"0","  }"
"0",""")"
"0",""
"0","dmeas <- Csnippet("""
"0","  if(t < 209){"
"0","    lik = dbinom(cases1, H_1, 0.06652121, 1) + dbinom(cases2, H_2, 0.06652121, 1) + dbinom(cases3, H_3, 0.06652121, 1);"
"0","  }"
"0","  else{"
"0","    lik = dbinom(cases1, H_1, 0.09283434, 1) + dbinom(cases2, H_2, 0.09283434, 1) + dbinom(cases3, H_3, 0.09283434, 1);"
"0","  }"
"0",""")"
